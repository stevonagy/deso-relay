<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>DeSo Identity Bridge</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  html,body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif }
  #wrap { position:fixed; inset:0; display:flex; flex-direction:column; }
  #bar { padding:10px 12px; background:#0f172a; font-size:13px; display:flex; gap:8px; align-items:center }
  #frame { flex:1; position:relative; }
  iframe { position:absolute; inset:0; width:100%; height:100%; border:0; background:#000; }
  #log { position:absolute; bottom:0; left:0; right:0; max-height:40%; overflow:auto; font-size:12px; background:#0b1220; padding:6px 10px; border-top:1px solid #17203a }
  .muted{opacity:.7}
</style>
</head>
<body>
  <div id="wrap">
    <div id="bar">DeSo Identity Bridge <span class="muted">– secure host</span></div>
    <div id="frame">
      <iframe id="id_iframe" src="https://identity.deso.org/embed?webview=true" allow="clipboard-read; clipboard-write"></iframe>
      <pre id="log"></pre>
    </div>
  </div>

<script>
(function(){
  const LOG = document.getElementById('log');
  const iframe = document.getElementById('id_iframe');
  const RN = (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) ? window.ReactNativeWebView : null;
  const ID_ORIGIN = 'https://identity.deso.org';

  // ---- helpers -------------------------------------------------------------
  function uiLog(obj){
    try { LOG.textContent += JSON.stringify(obj) + "\n"; LOG.scrollTop = LOG.scrollHeight; } catch {}
    try { RN && RN.postMessage(JSON.stringify({ kind:'debug', data: obj })); } catch {}
  }
  // pošalji poruku u iframe; targetOrigin='*' da budemo tolerantni na varijante
  function send(msg){ iframe.contentWindow && iframe.contentWindow.postMessage(msg, '*'); }
  function uid(){ return 'id-' + Math.random().toString(36).slice(2) + Date.now().toString(36); }

  // ---- params (tune preko query stringa) -----------------------------------
  const qs = new URLSearchParams(location.search);
  const appName = qs.get('appName') || 'DesoMobile';
  const submitPost = parseInt(qs.get('submitPost') || '10', 10);
  const expirationDays = parseInt(qs.get('expDays') || '30', 10);
  const desoFloat = parseFloat(qs.get('deso') || '0.05');
  const desoNanos = Math.round((isFinite(desoFloat) ? desoFloat : 0) * 1e9);

  const LIMIT = {
    AppName: appName,
    DerivedKeyExpirationDays: expirationDays,
    GlobalDESOLimit: desoNanos,
    TransactionCountLimitMap: { SUBMIT_POST: Math.max(1, submitPost) },
  };

  // ---- handshake state -----------------------------------------------------
  let sawIframeLoad = false;
  let sawAnyIdentityMsg = false;     // ✅ čim vidimo BILO koju poruku s identity origin-a
  let initializeAcked = false;       // kada dobijemo odgovor na initialize (možda bez 'service')
  let loginSent = false;
  let deriveSent = false;

  let tries = 0;
  const MAX_TRIES = 20;
  const TRY_DELAY_MS = 600;
  let timer = null;

  function sendInitialize() {
    const id = uid();
    const msg = { id, method:'initialize', payload:{}, /* service: 'identity' - nije nužno */ };
    uiLog({ event:'initialize_send', id, tries });
    send(msg);
  }

  function scheduleInitializeRetries() {
    if (tries >= MAX_TRIES || sawAnyIdentityMsg) return;
    tries++;
    sendInitialize();
    timer = setTimeout(scheduleInitializeRetries, TRY_DELAY_MS);
  }

  function sendLogin() {
    if (loginSent) return;
    loginSent = true;
    const id = uid();
    const msg = {
      id,
      method: 'login',
      payload: { accessLevelRequest: 2, webview: true },
      // service: 'identity' (nije nužno, embed gleda method)
    };
    uiLog({ event:'login_send', id });
    send(msg);
  }

  function sendDerive(pk) {
    if (deriveSent) return;
    deriveSent = true;
    const id = uid();
    const msg = {
      id,
      method: 'derive',
      payload: {
        PublicKeyBase58Check: pk,
        accessLevel: 2,
        webview: true,
        TransactionSpendingLimitResponse: LIMIT
      }
    };
    uiLog({ event:'derive_send', id, pk });
    send(msg);
  }

  // ---- lifecycle -----------------------------------------------------------
  iframe.addEventListener('load', function(){
    sawIframeLoad = true;
    uiLog({ event:'iframe_loaded' });
    // pokreni initialize s retryjem dok ne dobijemo ijednu identity poruku
    tries = 0;
    if (timer) clearTimeout(timer);
    scheduleInitializeRetries();
  });

  // ✅ prihvati BILO koju poruku koja dolazi s identity.deso.org
  window.addEventListener('message', function(e){
    if (e.origin !== ID_ORIGIN) return; // čuvamo sigurnost
    const m = e && e.data ? e.data : {};
    uiLog({ event:'identity_msg', origin: e.origin, hasService: !!m.service, method: m.method, hasPayload: !!m.payload });

    if (!sawAnyIdentityMsg) {
      sawAnyIdentityMsg = true;
      if (timer) { clearTimeout(timer); timer = null; }
      // čim vidimo prvi ping iz identity-ja, idemo na login
      sendLogin();
      return;
    }

    // Ako vidimo login odgovor (razni oblici), pokupi publicKey i šalji derive
    if ((m.method === 'login' || !m.method) && m.payload && (m.payload.publicKeyAdded || m.payload.publicKey || m.payload.PublicKeyBase58Check)) {
      const pk = m.payload.publicKeyAdded || m.payload.publicKey || m.payload.PublicKeyBase58Check;
      sendDerive(pk);
      return;
    }

    // Kad stigne derive payload, normaliziraj i proslijedi RN-u
    if (m.method === 'derive' && m.payload) {
      const p = m.payload || {};
      const out = {
        derivedPublicKeyBase58Check: p.derivedPublicKeyBase58Check || p.DerivedPublicKeyBase58Check || '',
        jwt: p.jwt || p.JWT || p.authToken || p.AuthToken || p.derivedJwt || p.DerivedJwt || '',
        publicKey: p.publicKey || p.PublicKeyBase58Check || '',
        encryptedSeedHex: p.encryptedSeedHex || p.EncryptedSeedHex || '',
        expirationBlock: p.expirationBlock || p.ExpirationBlock || ''
      };
      uiLog({ event:'derive_complete', haveJwt: !!out.jwt, haveDerived: !!out.derivedPublicKeyBase58Check });
      try { RN && RN.postMessage(JSON.stringify({ event:'derive-complete', params: out })); } catch {}
      return;
    }
  }, false);
})();
</script>
</body>
</html>
