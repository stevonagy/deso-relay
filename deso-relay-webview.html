<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DeSo Relay (with decrypt)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:24px}
    code{background:#f3f3f3;padding:2px 4px;border-radius:4px}
    .ok{color:#0a7a0a}.err{color:#a00}
  </style>
</head>
<body>
  <h3>DeSo Relay (decrypt-enabled)</h3>
  <div id="status">Booting…</div>

  <iframe id="identity" title="identity" src="https://identity.deso.org/embed?v=2" style="width:0;height:0;border:0;visibility:hidden"></iframe>

  <script>
    (function () {
      var el = document.getElementById('status');
      function log(html){ el.innerHTML = html; }

      function parseAll(url) {
        var out = {};
        try {
          var u = String(url || '');
          var iQ = u.indexOf('?');
          var iH = u.indexOf('#');

          function take(s) {
            if (!s) return;
            var raw = s.replace(/^[?#]/,''); if (!raw) return;
            raw.split('&').forEach(function(part){
              if (!part) return;
              var kv = part.split('=');
              var k = decodeURIComponent(kv[0] || '');
              var v = decodeURIComponent((kv[1] || ''));
              if (!k) return;
              out[k] = v;
            });
          }
          if (iQ >= 0) take(u.slice(iQ, iH >= 0 ? iH : u.length));
          if (iH >= 0) take(u.slice(iH));
        } catch(e) {}
        return out;
      }

      function safeJsonParse(str, fallback) {
        try { return JSON.parse(str); } catch (e) { return fallback; }
      }

      function redirectTo(uri, params) {
        var qs = new URLSearchParams();
        Object.keys(params || {}).forEach(function(k){
          if (typeof params[k] !== 'undefined') qs.set(k, String(params[k]));
        });
        var out = uri + (qs.toString() ? ('?' + qs.toString()) : '');
        log('<span class="ok">Redirecting…</span><br/><code>' + out + '</code>');
        setTimeout(function(){ location.href = out; }, 0);
      }

      var params = parseAll(location.href);
      var redirect = params.redirect;
      var kind = (params.kind || '').toLowerCase();
      var payload = safeJsonParse(params.payload || '{}', {});

      // RN WebView fallback (not used in this simple file)
      var isRN = !!(window.ReactNativeWebView && window.ReactNativeWebView.postMessage);

      // Helper: generic Identity postMessage call
      function callIdentity(method, payload) {
        return new Promise(function(resolve, reject){
          var iframe = document.getElementById('identity');
          if (!iframe || !iframe.contentWindow) return reject(new Error('No identity iframe'));
          var reqId = 'req_' + Date.now() + '_' + Math.random().toString(36).slice(2);

          function onMessage(e) {
            // Accept all origins but prefer identity
            var data = e && e.data;
            if (!data || (data.id !== reqId && data.service !== 'identity')) return;
            // v2 API: { id, service:'identity', method, payload } or { id, error }
            try {
              if (data.error) {
                window.removeEventListener('message', onMessage);
                return reject(new Error(data.error));
              }
              if (data.method === method || data.payload || data.decryptedHexes) {
                window.removeEventListener('message', onMessage);
                return resolve(data.payload || data.decryptedHexes || data);
              }
            } catch (err) {
              window.removeEventListener('message', onMessage);
              return reject(err);
            }
          }
          window.addEventListener('message', onMessage);

          var msg = { id: reqId, method: method, payload: payload, service: 'identity' };
          iframe.contentWindow.postMessage(msg, '*');
        });
      }

      // If not decrypt, just behave like the old relay: strip meta and redirect back.
      if (kind !== 'decrypt') {
        if (!redirect) {
          // Try to infer legacy redirect
          if (params.publicKeyAdded || params.PublicKey) redirect = 'desomobile://login';
          else if (params.derivedPublicKeyBase58Check || params.DerivedPublicKeyBase58Check) redirect = 'desomobile://derive';
        }
        if (!redirect) {
          log('<span class="err">No <code>redirect</code> provided.</span>');
          return;
        }
        var passthrough = {};
        Object.keys(params).forEach(function(k){
          if (k === 'redirect' || k === 'pkg') return;
          passthrough[k] = params[k];
        });
        return redirectTo(redirect, passthrough);
      }

      // kind=decrypt flow
      if (!redirect) {
        log('<span class="err">Decrypt: missing <code>redirect</code> URI.</span>');
        return;
      }

      var encryptedMessages = payload.encryptedMessages || payload.EncryptedMessages || [];
      if (!Array.isArray(encryptedMessages) || encryptedMessages.length === 0) {
        return redirectTo(redirect, { error: 'no_encrypted_messages' });
      }

      log('<span class="ok">Decrypting '+ encryptedMessages.length +' messages…</span>');

      callIdentity('decrypt', { encryptedMessages: encryptedMessages })
        .then(function(res){
          // res may be { decryptedHexes: { [EncryptedHex]: plaintext } } or just the map
          var map = res && (res.decryptedHexes || res.map || res.result || res);
          try {
            var json = JSON.stringify(map || {});
            redirectTo(redirect, { decryptedHexes: json });
          } catch (e) {
            redirectTo(redirect, { error: 'bad_json' });
          }
        })
        .catch(function(err){
          redirectTo(redirect, { error: String(err && err.message || err || 'decrypt_failed') });
        });
    })();
  </script>
</body>
</html>
